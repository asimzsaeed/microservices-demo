stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
    - script: |
        # Install AWS CLI
        python -m pip install --upgrade pip==9.0.3 setuptools wheel
        pip install awscli --user

        # Install Skaffold
        curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
        chmod +x skaffold
        sudo mv skaffold /usr/local/bin
      displayName: 'Install tools'
    - task: AWSShellScript@1
      inputs:
        awsCredentials: 'aws-staging'
        regionName: 'eu-west-1'
        scriptType: 'inline'
        inlineScript: |
          eval $(/home/vsts/.local/bin/aws ecr get-login --no-include-email)
      displayName: 'Login to ECR'
    #- script: |
    #    skaffold build --default-repo=935004547008.dkr.ecr.eu-west-1.amazonaws.com/microservices-demo
    #  displayName: 'Build images with skaffold'
- stage: Deploy
  jobs:
  - job: Deploy
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
    - script: |
        # Install kubectl
        curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
        chmod +x ./kubectl
        sudo mv ./kubectl /usr/local/bin/kubectl
    - task: AWSShellScript@1
      inputs:
        awsCredentials: 'aws-staging'
        regionName: 'eu-west-1'
        scriptType: 'inline'
        inlineScript: |
          aws eks update-kubeconfig --name ferocious-rainbow-1573565336
          cat ~/.kube/config
      displayName: 'Set kubeconfig'
    - script: |
        skaffold deploy --kube-context=ferocious-rainbow-1573565336 --default-repo=935004547008.dkr.ecr.eu-west-1.amazonaws.com/microservices-demo
      displayName: 'Deploy images with skaffold'
